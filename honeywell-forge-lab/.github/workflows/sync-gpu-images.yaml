# Sync GPU Operator Images for Airgapped Deployments
#
# This workflow downloads all NVIDIA GPU Operator images and:
#   1. Creates a GitHub Release with a single compressed archive
#   2. Includes loader script for easy import on airgapped K3s nodes
#   3. Supports ArgoCD/GitOps deployments in airgapped environments
#
# The release artifacts can be downloaded and imported on airgapped K3s nodes.

name: Sync GPU Images

on:
  workflow_dispatch:
    inputs:
      gpu_operator_version:
        description: 'GPU Operator version'
        required: false
        default: 'v25.10.1'
      driver_version:
        description: 'NVIDIA driver version'
        required: false
        default: '535.230.02'
      ubuntu_version:
        description: 'Ubuntu version for driver'
        required: false
        default: 'ubuntu20.04'
        type: choice
        options:
          - 'ubuntu20.04'
          - 'ubuntu22.04'
      create_release:
        description: 'Create GitHub Release with images'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
  schedule:
    # Run weekly to keep images fresh
    - cron: '0 2 * * 0'

env:
  GPU_OPERATOR_VERSION: ${{ github.event.inputs.gpu_operator_version || 'v25.10.1' }}
  DRIVER_VERSION: ${{ github.event.inputs.driver_version || '535.230.02' }}
  UBUNTU_VERSION: ${{ github.event.inputs.ubuntu_version || 'ubuntu20.04' }}

jobs:
  sync-images:
    name: Download GPU Operator Images
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache
          df -h

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y podman skopeo pigz

      - name: Create images list
        id: images
        run: |
          mkdir -p gpu-images

          cat > gpu-images/images.txt << EOF
          nvcr.io/nvidia/gpu-operator:${{ env.GPU_OPERATOR_VERSION }}
          nvcr.io/nvidia/cloud-native/k8s-driver-manager:v0.9.1
          nvcr.io/nvidia/driver:${{ env.DRIVER_VERSION }}-${{ env.UBUNTU_VERSION }}
          nvcr.io/nvidia/k8s/container-toolkit:v1.18.1
          nvcr.io/nvidia/k8s-device-plugin:v0.18.1
          nvcr.io/nvidia/k8s/dcgm-exporter:4.4.2-4.7.0-distroless
          nvcr.io/nvidia/k8s/gpu-feature-discovery:v0.18.1
          registry.k8s.io/nfd/node-feature-discovery:v0.18.2
          nvcr.io/nvidia/cuda:12.2.0-base-ubuntu22.04
          EOF

          echo "count=$(wc -l < gpu-images/images.txt)" >> $GITHUB_OUTPUT
          cat gpu-images/images.txt

      - name: Pull all images
        run: |
          while IFS= read -r img || [[ -n "$img" ]]; do
            img=$(echo "$img" | tr -d '[:space:]')
            [[ -z "$img" ]] && continue
            echo "========================================"
            echo "Pulling: $img"
            echo "========================================"
            podman pull "$img" || echo "WARNING: Failed to pull $img"
          done < gpu-images/images.txt

      - name: Save images individually
        run: |
          while IFS= read -r img || [[ -n "$img" ]]; do
            img=$(echo "$img" | tr -d '[:space:]')
            [[ -z "$img" ]] && continue

            # Create safe filename
            name=$(echo "$img" | sed 's|/|_|g' | sed 's/:/-/g')
            tar_file="gpu-images/${name}.tar"

            echo "Saving: $img -> $tar_file"
            podman save -o "$tar_file" "$img" || echo "WARNING: Failed to save $img"
          done < gpu-images/images.txt

      - name: Create loader script
        run: |
          cat > gpu-images/load-gpu-images.sh << 'SCRIPT'
          #!/bin/bash
          # =============================================================================
          # Load GPU Operator Images into K3s
          # =============================================================================
          # Usage: ./load-gpu-images.sh [tar-directory]
          #
          # This script imports all GPU Operator images into K3s containerd.
          # Run this on each K3s node that needs GPU support.
          # =============================================================================

          set -e

          TAR_DIR="${1:-.}"

          echo "=========================================="
          echo "Loading GPU Operator Images"
          echo "=========================================="
          echo "Source directory: $TAR_DIR"
          echo ""

          # Check if running on K3s node
          if ! command -v k3s &> /dev/null; then
              echo "ERROR: k3s not found. Run this on a K3s node."
              exit 1
          fi

          # Import each tar file
          for tar_file in "$TAR_DIR"/*.tar; do
              if [[ -f "$tar_file" ]]; then
                  echo "Importing: $(basename "$tar_file")"
                  sudo k3s ctr images import "$tar_file" || echo "WARNING: Failed to import $tar_file"
              fi
          done

          echo ""
          echo "=========================================="
          echo "Imported Images:"
          echo "=========================================="
          sudo k3s ctr images list | grep -E "nvidia|nfd" | head -20

          echo ""
          echo "Done! GPU Operator images are now available."
          SCRIPT

          chmod +x gpu-images/load-gpu-images.sh

      - name: Create checksums and manifest
        run: |
          cd gpu-images

          # Create checksums
          sha256sum *.tar > checksums.sha256

          # Create manifest
          cat > README.md << EOF
          # GPU Operator Images for Airgapped Deployment

          | Setting | Value |
          |---------|-------|
          | GPU Operator Version | ${{ env.GPU_OPERATOR_VERSION }} |
          | Driver Version | ${{ env.DRIVER_VERSION }} |
          | Ubuntu Version | ${{ env.UBUNTU_VERSION }} |
          | Generated | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |

          ## Images Included

          \`\`\`
          $(cat images.txt)
          \`\`\`

          ## Quick Start

          ### 1. Download and Extract

          \`\`\`bash
          # Download the release archive
          wget https://github.com/${{ github.repository }}/releases/download/gpu-images-${{ env.GPU_OPERATOR_VERSION }}/gpu-images-${{ env.GPU_OPERATOR_VERSION }}.tar.gz

          # Extract
          tar -xzf gpu-images-${{ env.GPU_OPERATOR_VERSION }}.tar.gz
          cd gpu-images
          \`\`\`

          ### 2. Transfer to Airgapped Environment

          \`\`\`bash
          # Copy to your jump host or airgapped node
          scp -r gpu-images/ user@jumphost:/tmp/

          # From jump host to K3s node
          scp -r /tmp/gpu-images/ dare@192.168.22.81:/tmp/
          \`\`\`

          ### 3. Load Images on K3s Node

          \`\`\`bash
          # SSH to K3s node
          ssh dare@192.168.22.81

          # Run the loader script
          cd /tmp/gpu-images
          ./load-gpu-images.sh

          # Or manually:
          for f in *.tar; do sudo k3s ctr images import "\$f"; done
          \`\`\`

          ### 4. Verify Images

          \`\`\`bash
          sudo k3s ctr images list | grep nvidia
          \`\`\`

          ## For ArgoCD/GitOps

          If using ArgoCD in an airgapped environment:

          1. Load images on all K3s nodes first
          2. Install GPU Operator with \`driver.enabled=false\` if using pre-installed drivers
          3. Or use the containerized driver with images pre-loaded

          \`\`\`bash
          helm upgrade --install gpu-operator nvidia/gpu-operator \\
            --namespace gpu-operator \\
            --create-namespace \\
            --set driver.version=${{ env.DRIVER_VERSION }}
          \`\`\`

          ## Checksums

          Verify integrity with:
          \`\`\`bash
          sha256sum -c checksums.sha256
          \`\`\`
          EOF

      - name: Create compressed archive
        run: |
          echo "Creating compressed archive..."
          tar -cvf - gpu-images/ | pigz -9 > gpu-images-${{ env.GPU_OPERATOR_VERSION }}.tar.gz

          echo ""
          echo "Archive created:"
          ls -lh gpu-images-${{ env.GPU_OPERATOR_VERSION }}.tar.gz

          # Also create sha256 for the archive
          sha256sum gpu-images-${{ env.GPU_OPERATOR_VERSION }}.tar.gz > gpu-images-${{ env.GPU_OPERATOR_VERSION }}.tar.gz.sha256

      - name: List all files
        run: |
          echo "=== Individual Image Files ==="
          ls -lh gpu-images/
          echo ""
          echo "=== Total Size ==="
          du -sh gpu-images/
          echo ""
          echo "=== Compressed Archive ==="
          ls -lh gpu-images-*.tar.gz*

      - name: Upload individual artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gpu-images-individual-${{ env.GPU_OPERATOR_VERSION }}
          path: gpu-images/
          retention-days: 30

      - name: Upload compressed archive
        uses: actions/upload-artifact@v4
        with:
          name: gpu-images-archive-${{ env.GPU_OPERATOR_VERSION }}
          path: |
            gpu-images-${{ env.GPU_OPERATOR_VERSION }}.tar.gz
            gpu-images-${{ env.GPU_OPERATOR_VERSION }}.tar.gz.sha256
          retention-days: 30

      - name: Create Release
        if: github.event.inputs.create_release == 'true' || github.event_name == 'schedule'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: gpu-images-${{ env.GPU_OPERATOR_VERSION }}
          name: GPU Operator Images ${{ env.GPU_OPERATOR_VERSION }}
          body_path: gpu-images/README.md
          files: |
            gpu-images-${{ env.GPU_OPERATOR_VERSION }}.tar.gz
            gpu-images-${{ env.GPU_OPERATOR_VERSION }}.tar.gz.sha256
            gpu-images/load-gpu-images.sh
            gpu-images/images.txt
            gpu-images/checksums.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## GPU Images Synced Successfully! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| GPU Operator | \`${{ env.GPU_OPERATOR_VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Driver | \`${{ env.DRIVER_VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Ubuntu | \`${{ env.UBUNTU_VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Images | ${{ steps.images.outputs.count }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Download Options" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **GitHub Release**: Download \`gpu-images-${{ env.GPU_OPERATOR_VERSION }}.tar.gz\`" >> $GITHUB_STEP_SUMMARY
          echo "2. **Artifacts**: Download from the Actions artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Usage" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Extract and load on K3s node" >> $GITHUB_STEP_SUMMARY
          echo "tar -xzf gpu-images-${{ env.GPU_OPERATOR_VERSION }}.tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "cd gpu-images && ./load-gpu-images.sh" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
