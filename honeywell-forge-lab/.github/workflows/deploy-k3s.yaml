# Honeywell Forge Cognition - K3s Deployment Pipeline
#
# This workflow deploys a K3s cluster to ESXi without requiring vCenter.
# It clones VMs from a template and installs K3s automatically.
#
# Prerequisites:
#   1. Ubuntu template VM created on ESXi (see scripts/create-ubuntu-template.sh)
#   2. GitHub Secrets configured:
#      - ESXI_HOST: ESXi IP address (e.g., 192.168.1.144)
#      - ESXI_PASSWORD: ESXi root password
#      - SSH_PUBLIC_KEY: SSH public key for VM access (optional)
#
# Usage:
#   1. Go to Actions tab in GitHub
#   2. Select "Deploy K3s Cluster"
#   3. Click "Run workflow"
#   4. Choose action: deploy or destroy

name: Deploy K3s Cluster

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - destroy
      k3s_server_name:
        description: 'K3s server VM name'
        required: false
        default: 'k3s-server'
      k3s_agent_name:
        description: 'K3s agent VM name'
        required: false
        default: 'k3s-gpu-agent'
  push:
    branches:
      - main
    paths:
      - 'honeywell-forge-lab/infrastructure/scripts/deploy-k3s-cluster.sh'

env:
  ESXI_HOST: ${{ secrets.ESXI_HOST }}
  ESXI_USER: root
  ESXI_PASSWORD: ${{ secrets.ESXI_PASSWORD }}
  SSH_PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }}
  TEMPLATE_NAME: ubuntu-template
  K3S_SERVER_NAME: ${{ github.event.inputs.k3s_server_name || 'k3s-server' }}
  K3S_AGENT_NAME: ${{ github.event.inputs.k3s_agent_name || 'k3s-gpu-agent' }}

jobs:
  deploy:
    name: ${{ github.event.inputs.action || 'deploy' }} K3s Cluster
    runs-on: ubuntu-latest
    # Only run on self-hosted runner if available (has network access to ESXi)
    # runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: Validate secrets
        run: |
          if [[ -z "${{ secrets.ESXI_HOST }}" ]]; then
            echo "::error::ESXI_HOST secret is not set"
            exit 1
          fi
          if [[ -z "${{ secrets.ESXI_PASSWORD }}" ]]; then
            echo "::error::ESXI_PASSWORD secret is not set"
            exit 1
          fi

      - name: Test ESXi connectivity
        run: |
          sshpass -p "${{ secrets.ESXI_PASSWORD }}" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
            root@${{ secrets.ESXI_HOST }} "echo 'ESXi connection OK'"

      - name: Deploy K3s Cluster
        if: github.event.inputs.action != 'destroy'
        working-directory: honeywell-forge-lab/infrastructure/scripts
        run: |
          chmod +x deploy-k3s-cluster.sh
          ./deploy-k3s-cluster.sh

      - name: Destroy K3s Cluster
        if: github.event.inputs.action == 'destroy'
        working-directory: honeywell-forge-lab/infrastructure/scripts
        run: |
          chmod +x deploy-k3s-cluster.sh
          ./deploy-k3s-cluster.sh --destroy

      - name: Upload cluster info
        if: github.event.inputs.action != 'destroy'
        uses: actions/upload-artifact@v4
        with:
          name: cluster-info
          path: honeywell-forge-lab/infrastructure/scripts/cluster-info.txt
          retention-days: 30

      - name: Get kubeconfig
        if: github.event.inputs.action != 'destroy'
        continue-on-error: true
        run: |
          if [[ -f honeywell-forge-lab/infrastructure/scripts/cluster-info.txt ]]; then
            source honeywell-forge-lab/infrastructure/scripts/cluster-info.txt
            sshpass -p "dare" scp -o StrictHostKeyChecking=no \
              dare@${K3S_SERVER_IP}:/etc/rancher/k3s/k3s.yaml ./kubeconfig.yaml
            sed -i "s/127.0.0.1/${K3S_SERVER_IP}/g" ./kubeconfig.yaml
          fi

      - name: Upload kubeconfig
        if: github.event.inputs.action != 'destroy'
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: kubeconfig
          path: kubeconfig.yaml
          retention-days: 7

      - name: Summary
        if: github.event.inputs.action != 'destroy'
        run: |
          if [[ -f honeywell-forge-lab/infrastructure/scripts/cluster-info.txt ]]; then
            source honeywell-forge-lab/infrastructure/scripts/cluster-info.txt
            echo "## K3s Cluster Deployed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Component | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| K3s Server | ${K3S_SERVER_NAME} (${K3S_SERVER_IP}) |" >> $GITHUB_STEP_SUMMARY
            echo "| K3s Agent | ${K3S_AGENT_NAME} (${K3S_AGENT_IP}) |" >> $GITHUB_STEP_SUMMARY
            echo "| ESXi Host | ${ESXI_HOST} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Access Commands" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "# SSH to K3s server" >> $GITHUB_STEP_SUMMARY
            echo "ssh dare@${K3S_SERVER_IP}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# View cluster nodes" >> $GITHUB_STEP_SUMMARY
            echo "sudo kubectl get nodes" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

  # ==========================================================================
  # GPU Setup Job (runs after deploy, optional)
  # ==========================================================================
  setup-gpu:
    name: Setup GPU Drivers
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event.inputs.action != 'destroy'
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get install -y sshpass

      - name: Download cluster info
        uses: actions/download-artifact@v4
        with:
          name: cluster-info

      - name: Check GPU availability
        run: |
          if [[ -f cluster-info.txt ]]; then
            source cluster-info.txt
            echo "Checking GPU on ${K3S_AGENT_IP}..."
            sshpass -p "dare" ssh -o StrictHostKeyChecking=no dare@${K3S_AGENT_IP} << 'ENDSSH'
          echo "=== Checking for NVIDIA GPU ==="
          lspci | grep -i nvidia || echo "No NVIDIA GPU detected (GPU passthrough may not be configured)"

          echo ""
          echo "=== Checking NVIDIA driver ==="
          nvidia-smi 2>/dev/null || echo "NVIDIA drivers not installed"

          echo ""
          echo "Note: GPU passthrough must be configured in ESXi before GPU is visible."
          echo "See: honeywell-forge-lab/docs/GPU_PASSTHROUGH_GUIDE.md"
          ENDSSH
          fi

      - name: GPU Summary
        run: |
          echo "## GPU Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "GPU passthrough must be manually configured in ESXi:" >> $GITHUB_STEP_SUMMARY
          echo "1. ESXi Host > Configure > Hardware > PCI Devices" >> $GITHUB_STEP_SUMMARY
          echo "2. Select NVIDIA GPU > Toggle Passthrough" >> $GITHUB_STEP_SUMMARY
          echo "3. Reboot ESXi host" >> $GITHUB_STEP_SUMMARY
          echo "4. Edit VM > Add PCI Device > Select GPU" >> $GITHUB_STEP_SUMMARY
