# Parabricks Workbench Image
# This creates a Jupyter notebook environment with Clara Parabricks tools

FROM quay.io/opendatahub/workbench-images:jupyter-datascience-ubi9-python-3.11-20241111-16bbbe5

USER 0

# Install dependencies needed for Parabricks
RUN dnf install -y \
    wget \
    bzip2 \
    && dnf clean all

# Download and install Clara Parabricks
# Note: In production, you would copy this from the NVIDIA image or install properly
# For now, we'll create a script that demonstrates the integration

RUN mkdir -p /opt/parabricks

# Create a wrapper script for pbrun (placeholder until we integrate the actual binary)
RUN echo '#!/bin/bash' > /opt/parabricks/pbrun && \
    echo 'echo "Clara Parabricks pbrun wrapper"' >> /opt/parabricks/pbrun && \
    echo 'echo "This is a demonstration. In production, this would call the actual pbrun binary."' >> /opt/parabricks/pbrun && \
    echo 'echo "Arguments: $@"' >> /opt/parabricks/pbrun && \
    chmod +x /opt/parabricks/pbrun

# Add Parabricks to PATH
ENV PATH="/opt/parabricks:${PATH}"

# Install Python packages commonly used with genomics workflows
RUN pip install --no-cache-dir \
    biopython \
    pysam \
    pandas \
    matplotlib \
    seaborn

# Create a sample notebook
RUN mkdir -p /opt/app-root/src/notebooks

RUN cat > /opt/app-root/src/notebooks/parabricks_example.ipynb << 'EOF'
{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Clara Parabricks Example Notebook\n",
    "\n",
    "This notebook demonstrates using NVIDIA Clara Parabricks for genomics analysis."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "import subprocess\n",
    "import os\n",
    "\n",
    "print(\"Parabricks Environment Check\")\n",
    "print(\"=\" * 50)\n",
    "\n",
    "# Check if pbrun is available\n",
    "result = subprocess.run(['which', 'pbrun'], capture_output=True, text=True)\n",
    "if result.returncode == 0:\n",
    "    print(f\"✓ pbrun found at: {result.stdout.strip()}\")\n",
    "else:\n",
    "    print(\"✗ pbrun not found\")\n",
    "\n",
    "# Check pbrun version\n",
    "result = subprocess.run(['pbrun', 'version'], capture_output=True, text=True)\n",
    "print(f\"\\nParabricks output:\\n{result.stdout}\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Running Parabricks Commands\n",
    "\n",
    "Example of running Parabricks germline pipeline:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Example Parabricks command (demonstration)\n",
    "# In production, you would provide actual input files\n",
    "\n",
    "cmd = [\n",
    "    'pbrun', 'germline',\n",
    "    '--help'\n",
    "]\n",
    "\n",
    "print(\"Running: \" + ' '.join(cmd))\n",
    "result = subprocess.run(cmd, capture_output=True, text=True)\n",
    "print(result.stdout)"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "name": "python",
   "version": "3.11.0"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
EOF

# Set permissions
RUN chown -R 1001:0 /opt/app-root/src && \
    chmod -R g+w /opt/app-root/src

USER 1001

WORKDIR /opt/app-root/src

CMD ["/opt/app-root/bin/start-notebook.sh"]
